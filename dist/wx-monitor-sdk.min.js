!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).monitorSdk=t()}(this,function(){"use strict";function t(e){this.config=e}t.prototype={request:function(e,t){var n=this.config,r=n.url;if(!n.key)throw new Error("please set sdk key");if(!r)throw new Error("please set sdk url");wx.rewriteRequest({url:r+e,method:"POST",data:t})}};var u="";function e(e){this.breadcrumb={},this.pageStack=[],this.systemInfo={},this.accountInfo={},this.report=new t(e),this.callback=function(){},this.getSystemInfo(),this.rewriteRequest(),this.rewriteApp(),this.rewritePage(),this.rewriteComponent()}return e.prototype={pushBreadcrumd:function(e,t){var n;t&&(u=t,(n=this.breadcrumb[t])?(n.push(e),20<n.length&&n.shift()):this.breadcrumb[t]=[e])},clearBreadCrumd:function(e){this.breadcrumb[e]=[]},getSystemInfo:function(){var t=this,e=wx.getAccountInfoSync();this.accountInfo=e,wx.getSystemInfo({success:function(e){t.systemInfo=e}})},rewriteRequest:function(){var e=wx.request,u=this;wx.rewriteRequest=function(r){var o=r.success;return r.success=function(e){var t=u.getActivePage(),n={time:+new Date,belong:"request",method:"successFn",route:t.route||"none",httpUrl:r.url};return u.pushBreadcrumd(n,t.route),o&&o(e)},e(r)}},rewriteApp:function(){var r=App,o=this;App=function(e){var t=e.onError,n=e.onLaunch;return e.onError=function(e){return o.error({msg:e,key:u}),t&&t.call(this,e)},e.onLaunch=function(e){var t={time:+new Date,belong:"App",method:"onLaunch",route:"none",arguments:"none"};return o.pushBreadcrumd(t,"onLaunch"),n&&n.call(this,e)},r(e)}},_normalPage:function(e){e=e||{};var t=Object.keys(e);return-1===t.indexOf("onLoad")&&(t.push("onLoad"),e.onLoad=function(){}),-1===t.indexOf("onUnload")&&(t.push("onUnload"),e.onUnload=function(){}),{page:e,pageMethods:t}},rewritePage:function(){var r=Page,o=this;Page=function(e){var t=o._normalPage(e),n=t.pageMethods;return e=t.page,n.forEach(function(n){var r;"function"==typeof e[n]&&(r=e[n],e[n]=function(){var e=o.getActivePage(),t={time:+new Date,belong:"Page",method:n,route:e.route||"none",arguments:Object.keys(arguments).length?JSON.stringify(arguments):"none"};return o.pushBreadcrumd(t,e.route),"onLoad"===n&&o.pageStack.push(e.route),"onUnload"===n&&(o.pageStack.splice(-1,1),o.clearBreadCrumd(e.route)),r&&r.apply(this,arguments)})}),r(e)}},rewriteComponent:function(){var e=Component,u=this;Component=function(o){return Object.keys(o).forEach(function(n){var r;"function"==typeof o[n]&&(r=o[n],o[n]=function(){var e=u.getActivePage(),t=o.name||"undefined component's name",t={time:+new Date,belong:"Component:".concat(t),method:n,route:e.route||"none",arguments:Object.keys(arguments).length?JSON.stringify(arguments):"none"};return u.pushBreadcrumd(t,e.route),r.apply(this,arguments)})}),e(o)}},error:function(e){this.callback&&this.callback({msg:e.msg,breadcrumb:JSON.parse(JSON.stringify(this.breadcrumb[u])),pageStack:this.pageStack,systemInfo:this.systemInfo,accountInfo:this.accountInfo,key:u})},getActivePage:function(){var e=getCurrentPages();return e.length?e[e.length-1]:{}}},e});
